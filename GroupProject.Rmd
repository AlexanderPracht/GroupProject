---
title: "GroupProject"
author: "Group 29"
date: "10/18/2020"
output: html_document
---
```{r, loadinglibs}
library(vroom)
library(dplyr)
library(skimr)
library(tidyverse)
library(mosaic)
library(janitor)
library(skimr)
library(broom)
library(lubridate)
library(GGally)
library(leaflet)
library(ggfortify)
library(huxtable)
library(car)
library(kableExtra)
library(data.table)
library(modelr)
library(readr)
```



## Loading Data

First we are going to read the data directly from the URL:
```{r}
listings <- vroom::vroom("http://data.insideairbnb.com/china/hk/hong-kong/2020-06-15/data/listings.csv.gz", na=c("", "NA", "N/A"))%>%
  clean_names()
```


# Exploratory Data Analysis (EDA)

## Looking at the raw values

### How many variables/columns? How many rows/observations?

We have 106 variables and 11,187 observations.

```{r}
glimpse(listings)
```

## Which variables are numbers?

1. 

```{r}
skim(listings)%>%
  kable()%>%
  kable_styling()
```


We selected the ones we found interesting:

```{r}
intersting_data <- listings %>%
  select(c(1, 2, host_since, host_response_time, host_response_rate, host_is_superhost, host_listings_count, host_has_profile_pic, host_identity_verified, neighbourhood_cleansed, latitude, longitude, is_location_exact, property_type, room_type, accommodates, bathrooms, bedrooms, beds, bed_type, price, security_deposit, cleaning_fee, guests_included, extra_people, minimum_nights, maximum_nights, has_availability, number_of_reviews, number_of_reviews_ltm, review_scores_rating, review_scores_accuracy, review_scores_cleanliness, review_scores_checkin, review_scores_communication, review_scores_location, review_scores_value, instant_bookable, cancellation_policy, reviews_per_month))
```

In order to run models with our data, we need to modify some variables and create some new variables that we want to examine. 

First, we must change the price variables (price, cleaning_fee, extra_people, and security_deposit) to numeric variables, as they are now characters. 

```{r}
main_data <- intersting_data %>%
  mutate(host_response_rate = parse_number(host_response_rate),
         price = parse_number(price),
         security_deposit = parse_number(security_deposit),
         cleaning_fee = parse_number(cleaning_fee),
         extra_people = parse_number(extra_people))%>%
  filter(has_availability == TRUE, minimum_nights <= 4, maximum_nights >= 4,
         price > 0,
         accommodates >= 2)

#skim(main_data)
```

DIVIDE THIS PART IN DIFFERNT CHUNKS

```{r}
main_data %>% 
  select(price, cleaning_fee, extra_people, host_response_rate, security_deposit) %>% 
  skim()%>%
  kable()%>%
  kable_styling()

# Making values for security deposit and claening fee 0 if they are NA
main_data2 <- main_data %>%
  mutate(cleaning_fee = replace_na(cleaning_fee, 0),
         security_deposit = replace_na(security_deposit, 0))


# Changing host_response_time to a factor variable 

#To simplify the `property_type` variable into 5 categories, Mutate others to gather the other property type with small values

top6_prop_type <- main_data2 %>%
  group_by(property_type)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:6)

main_data3 <- main_data2 %>%
  mutate(prop_type_simplified = case_when(
    property_type %in% c("Apartment", "Condominium", "Hostel", "Serviced apartment", "Guesthouse", "House") ~ property_type, 
    TRUE ~ "Other"
  ))

## Neighborhood_cleansed
top6_neighbourhood_type <- main_data2 %>%
  group_by(neighbourhood_cleansed)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:6)

main_data3 <- main_data3 %>%
  mutate(neighbourhood_cleansed = case_when(
    neighbourhood_cleansed %in% c("Yau Tsim Mong", "Central & Western", "	
Wan Chai", "Kowloon City", "Islands", "Eastern") ~ neighbourhood_cleansed, 
    TRUE ~ "Other"
  ))

## Room type
top4_room_type <- main_data2 %>%
  group_by(room_type)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:6)

## No adjustment needed because room_type only has 4 values


## bed_type
top6_bed_type <- main_data2 %>%
  group_by(bed_type)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:6)

## we wont look into this variable as almost all observations are the same category

## cancellation_policy
top6_cancel_type <- main_data2 %>%
  group_by(cancellation_policy)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:10)

### we will make one bucket for all strict policies

main_data3 <- main_data3 %>%
  mutate(cancellation_policy = case_when(
    cancellation_policy %in% c("strict_14_with_grace_period", "super_strict_60", "super_strict_30", "strict") ~ "strict", 
    TRUE ~ cancellation_policy
  ))

## Host response time
top6_host_time_type <- main_data2 %>%
  group_by(host_response_time)%>%
  summarise(count =n())%>%
  arrange(desc(count))%>%
  slice(1:6)

### We only have 4 types of response time so we will keep it this way

# Factoring the categories

main_data4 <- main_data3 %>%
  mutate(neighbourhood_cleansed = factor(neighbourhood_cleansed, order = TRUE, levels = c("Kowloon City", "Islands", "Central & Western", "Yau Tsim Mong", "Eastern", "Other")),
         room_type = factor(room_type, order = TRUE, levels = c("Entire home/apt", "Hotel room", "Private room", "Shared room")),
         host_response_time = factor(host_response_time, order = TRUE, levels = c("within an hour", "within a few hours", "within a day","a few days or more")),
         cancellation_policy = factor(cancellation_policy, order = TRUE, levels = c("flexible", "moderate", "strict")),
        host_since_calculated = Sys.Date() - host_since)


```

## Creating price_4_nights 

```{r}
main_data4 <- main_data4%>%
  filter(guests_included<=2)%>% 
  mutate(
    extra_charge_pp= case_when(guests_included==2 ~ 0, guests_included ==1 ~ extra_people),
    price_4_nights= price*4 + extra_charge_pp*4 + cleaning_fee
  )
```



HERE WE WILL MAKE PLOTS FROM THE DATA
ggpairs
ggplot
geom_boxplot
```{r}

```


# Mapping

```{r, mapping}
leaflet(data = main_data4) %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 1, 
                   fillColor = "blue", 
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type)
```

# Regression Analysis 

## Visualizing the distribution of price_4_nights
```{r}
#density plot price_4_nights
ggplot(data=main_data4, aes(x=price_4_nights)) +
  geom_density(fill = "blue", alpha = 0.3) +
  labs(x="Price for Four Nights") +
  theme_minimal()
## This graph doesnt help us as we cant interpret it so we will try log...

#density plot log
ggplot(data=main_data4, aes(x=price_4_nights)) + 
  scale_x_log10()+geom_density(fill = "blue", alpha = 0.3) + 
  labs(x="log of Price for Four Nights") +
  theme_minimal()
```
## Model 1: prop_type_simplified, number_of_reviews, review_scores_rating
Next, we fit a regression model with 3 explanatory variables: prop_type_simplified, number_of_reviews, and review_scores_rating.
```{r, model1}

# ***** Fit linear regression models: First, just the mean

model0 <- lm((log(price_4_nights)) ~ 1, data= main_data4)

model0 %>% 
  broom::tidy(conf.int=TRUE)

model0 %>% 
  broom::glance()

# ***** Fit linear regression models: criminals on 3 explanatory variables.
model1 <- lm(log(price_4_nights) ~ prop_type_simplified + number_of_reviews + review_scores_rating, data= main_data4)

model1 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model1 %>% 
  broom::glance()%>%
 kable()%>%
  kable_styling()

```


###  Model 2: adding room_type 

We want to determine if room_type is a significant predictor of the cost for 4 nights, given everything else in the model. 
```{r}

# ***** Fit linear regression models: criminals on 4 explanatory variables.
model2 <- lm(log (price_4_nights) ~ prop_type_simplified +number_of_reviews +  review_scores_rating + room_type, data= main_data4)

model2 %>% 
  broom::tidy(conf.int=TRUE)%>%
   kable()%>%
  kable_styling()

model2 %>% 
  broom::glance()%>%
   kable()%>%
  kable_styling()
```
All else equal, room_typePrivate room and room_typeShared room are significant predictors of the cost for 4 night as it has T-statistics >XXXXX and p-value XXXXXXXXX. 

room_typeHotel room does not seem to be significantly different from the baseline room_type variable ("Entire home/apt") as its |T statistic| < 2.

Now we will explore adding further variables. 

### Model 3: Improving model with room info

We start our own exploration now. We first wonder if we can improve model 2. Number of reviews ltm makes it better

```{r}
glimpse(main_data4)
model3 <- lm(log (price_4_nights) ~  bathrooms + bedrooms + beds + 
               accommodates + prop_type_simplified + number_of_reviews  +  number_of_reviews_ltm +  review_scores_rating + room_type, data= main_data4)

model3 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model3 %>% 
  broom::glance()%>%
  kable()%>%
  kable_styling()

msummary(model3)
car::vif(model3)
autoplot(model3)
```

After taking number_of_reviews away, we find that there is almost no change in adjusted R-squared. Also, there is no change in collinearity and significance after eliminating number_of_reviews. So, we can get rid of number_of_reviews in our model.

### Model 4: Adding bathrooms, bedrooms, beds, accommodates

Now, let's take a look at the number of bathrooms, bedrooms, beds and the number of people they can accommodates. We want to know if they are significant in predicting price of 4 nights in Cape Town.

```{r}
glimpse(main_data4)
model4 <- lm(log (price_4_nights) ~  bedrooms + accommodates + prop_type_simplified + number_of_reviews + number_of_reviews_ltm +  review_scores_rating + room_type, data= main_data4)

model4 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model4 %>% 
  broom::glance()%>%
  kable()%>%
  kable_styling()

msummary(model4)
car::vif(model4)
autoplot(model4)

```

bathroom, and bed took out didnt makes no differnce
bedroom made it lower
accommodates makes a differnce

### Model 5: Adding Host

XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

```{r}
#glimpse(main_data)

model5 <- lm(log (price_4_nights) ~  host_response_time + host_response_rate + host_is_superhost + host_has_profile_pic + host_since_calculated + bedrooms + accommodates + prop_type_simplified + number_of_reviews + number_of_reviews_ltm + review_scores_rating + room_type, data= main_data4)

model5 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model5 %>% 
  broom::glance()%>%
  kable()%>%
  kable_styling()

msummary(model5)
car::vif(model5)
autoplot(model5)

```

### Model 6: Adding SUper Host

```{r}
#glimpse(main_data)

model6 <- lm(log (price_4_nights) ~  host_response_time + host_is_superhost + host_has_profile_pic + host_since_calculated + bedrooms + accommodates + prop_type_simplified + number_of_reviews + number_of_reviews_ltm + review_scores_rating + room_type, data= main_data4)

model6 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model6 %>% 
  broom::glance()%>%
  kable()%>%
  kable_styling()

msummary(model6)
car::vif(model6)
autoplot(model6)

```
VIF!!!

### Model 7: Adding 

```{r}
glimpse(main_data4)

model7 <- lm(log (price_4_nights) ~  host_response_time + host_response_rate + host_is_superhost +  host_since_calculated + bedrooms + accommodates + prop_type_simplified + number_of_reviews_ltm +  review_scores_rating + room_type, data= main_data4)

model7 %>% 
  broom::tidy(conf.int=TRUE)%>%
  kable()%>%
  kable_styling()

model7 %>% 
  broom::glance()%>%
  kable()%>%
  kable_styling()

msummary(model7)
car::vif(model7)
autoplot(model7)

```
